# FiskAI CI Pipeline
# All builds run on ArtemiPC self-hosted runner with aggressive caching
# VPS never builds - only pulls prebuilt images from GHCR
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: "22"
  NODE_OPTIONS: "--max-old-space-size=8192"
  DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci?schema=public"

# Only one heavy job at a time per branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # All quality gates in one job to maximize cache reuse
  quality:
    name: Quality Gates
    runs-on: [self-hosted, artemipc, x86_64, fiskai]
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ci
          POSTGRES_PASSWORD: ci
          POSTGRES_DB: ci
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Prisma
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.prisma
            node_modules/@prisma/client
          key: prisma-${{ runner.os }}-${{ hashFiles('prisma/schema.prisma') }}
          restore-keys: |
            prisma-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Validate Prisma schema
        run: npx prisma validate

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: TypeScript check
        id: typecheck
        continue-on-error: true
        run: |
          npx tsc --noEmit 2>&1 | tee typescript-errors.log
          EXIT_CODE=${PIPESTATUS[0]}
          ERROR_COUNT=$(grep -c "error TS" typescript-errors.log || echo "0")
          echo "## TypeScript Errors: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "::warning::TypeScript check found $ERROR_COUNT errors"
          fi
          exit $EXIT_CODE

      - name: Security audit
        run: npm audit --audit-level=high

      - name: Unit tests
        run: npm test

      - name: Apply migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci?schema=test_${{ github.run_id }}"

      - name: Integration tests
        run: node --import tsx --test src/lib/regulatory-truth/__tests__/*.test.ts
        env:
          DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci?schema=test_${{ github.run_id }}"

  build:
    name: Build & Push
    runs-on: [self-hosted, artemipc, x86_64, fiskai]
    needs: [quality]
    timeout-minutes: 45

    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.push.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Prisma
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.prisma
            node_modules/@prisma/client
          key: prisma-${{ runner.os }}-${{ hashFiles('prisma/schema.prisma') }}

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            nextjs-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build Next.js
        run: npm run build
        env:
          REGULATORY_DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          NEXTAUTH_SECRET: "build-time-secret-not-used-at-runtime"
          NEXTAUTH_URL: "http://localhost:3000"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=pr,prefix=pr-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | artemipc-runner |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.meta.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | linux/amd64 |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "| Pushed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pushed | No (PR only) |" >> $GITHUB_STEP_SUMMARY
          fi
