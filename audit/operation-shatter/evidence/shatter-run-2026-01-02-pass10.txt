{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice1 create + PDF",
  "input": {
    "buyer": {
      "name": "EU Client GmbH",
      "vatNumber": "DE123456789",
      "country": "DE"
    },
    "invoice": {
      "issueDate": "2026-01-05T00:00:00.000Z",
      "invoiceNumber": "1-1-1"
    },
    "lines": [
      {
        "description": "Consulting",
        "quantity": 1,
        "unitPrice": 1000,
        "vatRate": 0
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/invoice-numbering.ts",
      "fn": "getNextInvoiceNumber"
    },
    {
      "file": "src/lib/vat/output-calculator.ts",
      "fn": "buildVatLineTotals"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create"
    },
    {
      "file": "src/lib/pdf/generate-invoice-pdf-artifact.ts",
      "fn": "generateInvoicePdfArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwug1xg000cs7wadne65yh4",
        "fields": {
          "invoiceNumber": "1-1-1",
          "status": "SENT"
        }
      },
      {
        "model": "EInvoiceLine",
        "id": "cmjwug1xm000ds7wazlk9xa7w",
        "fields": {
          "vatRate": "0.00",
          "vatAmount": "0.00"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwug2gd000gs7wa3zy3zh33",
        "type": "PDF",
        "fileName": "racun-1-1-1.pdf",
        "checksum": "cb97f19057ad40d01f7b34a822f7c74a904b7dc8f03b191c3e6f72c15d2d4732",
        "storageKey": "attachments/cmjwug1r00001s7wazhm8un1e/2000/01/d8872c99_cb97f19057ad40d01f7b34a822f7c74a904b7dc8f03b191c3e6f72c15d2d4732.pdf",
        "generatorVersion": "invoice-pdf@1",
        "inputHash": "a734a4e13050942ef6504cbb07aafe243f7b85b3dc60ba460c5a56289e9fde4e"
      }
    ],
    "notes": {
      "pdfContainsReverseChargeNote": true
    }
  }
}
{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice2 fiscalize + sabotage + credit note",
  "input": {
    "invoice2": {
      "invoiceNumber": "2-1-1",
      "totalAmount": "230.00"
    },
    "fiscalize": {
      "demo": true,
      "paymentMethod": "CASH"
    },
    "sabotage": {
      "update": {
        "totalAmount": "1.00"
      }
    },
    "creditNote": {
      "correctsInvoiceId": "cmjwug33a000qs7waz49dmy0h",
      "fullRefund": true
    }
  },
  "process": [
    {
      "file": "src/lib/fiscal/pos-fiscalize.ts",
      "fn": "fiscalizePosSale"
    },
    {
      "file": "src/lib/prisma-extensions.ts",
      "fn": "enforceInvoiceImmutability"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create (CREDIT_NOTE)"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwug33a000qs7waz49dmy0h",
        "fields": {
          "jir": "DEMO-2a73209ab449a92a634512c400147038",
          "fiscalizedAt": "2026-01-02T12:22:11.139Z"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwug39e000ys7wak2iv1bk4",
        "fields": {
          "correctsInvoiceId": "cmjwug33a000qs7waz49dmy0h",
          "totalAmount": "-230.00"
        }
      }
    ],
    "notes": {
      "sabotageError": "InvoiceImmutabilityError: Issued invoices are immutable. Attempted to update fields [totalAmount] on invoice in status PENDING_FISCALIZATION. Use a credit note for corrections."
    }
  }
}
{
  "correlationId": "SHATTER-S2",
  "step": "S2.Expense→Asset→MonthClose→Lock",
  "input": {
    "expense": {
      "vendor": "Links d.o.o.",
      "item": "MacBook Pro M3",
      "net": "2500.00",
      "vat": "625.00",
      "total": "3125.00"
    },
    "depreciation": {
      "usefulLifeMonths": 24,
      "expectedMonth1": "104.16"
    },
    "monthClose": {
      "month": "2026-01"
    },
    "sabotage": {
      "expenseUpdateDescription": "Tampered"
    }
  },
  "process": [
    {
      "file": "src/lib/fixed-assets/asset-candidates.ts",
      "fn": "emitAssetCandidates"
    },
    {
      "file": "src/lib/fixed-assets/conversion.ts",
      "fn": "convertFixedAssetCandidateToAsset"
    },
    {
      "file": "src/lib/assets/depreciation.ts",
      "fn": "postDepreciationEntriesForPeriod"
    },
    {
      "file": "src/lib/month-close/service.ts",
      "fn": "runMonthClose"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "Expense",
        "id": "cmjwug3by0017s7warg7di779",
        "fields": {
          "totalAmount": "3125.00",
          "status": "PENDING"
        }
      },
      {
        "model": "FixedAssetCandidate",
        "id": "cmjwug3e9001es7wa9p56fehw",
        "fields": {
          "status": "PENDING",
          "amount": "3125.00",
          "thresholdValue": "464.53"
        }
      },
      {
        "model": "FixedAsset",
        "id": "cmjwug3f6001fs7wao7utosw6",
        "fields": {
          "acquisitionCost": "2500.00",
          "usefulLifeMonths": 24
        }
      },
      {
        "model": "AccountingPeriod",
        "id": "cmjwug3jf0027s7war9wfsvb3",
        "fields": {
          "status": "LOCKED",
          "startDate": "2025-12-31T23:00:00.000Z"
        }
      }
    ],
    "notes": {
      "lockError": "AccountingPeriodLockedError: Cannot modify Expense on 2026-01-10T00:00:00.000Z: accounting period is locked."
    }
  }
}
{
  "correlationId": "SHATTER-S3",
  "step": "S3.Import + AutoMatch",
  "input": {
    "invoices": [
      {
        "id": "cmjwug3ts002os7wawbmpf3jr",
        "invoiceNumber": "4-1-1",
        "total": "100.00"
      },
      {
        "id": "cmjwug3v9002ss7wa9d0c052d",
        "invoiceNumber": "5-1-1",
        "total": "100.00"
      }
    ],
    "transactions": [
      {
        "amount": "98.00",
        "reference": null
      },
      {
        "amount": "102.00",
        "reference": "5-1-1"
      },
      {
        "amount": "-5.00",
        "description": "Bank naknada"
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/banking/import/import-parsed.ts",
      "fn": "importParsedBankTransactions"
    },
    {
      "file": "src/lib/banking/reconciliation-service.ts",
      "fn": "runAutoMatchTransactions"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "StatementImport",
        "id": "cmjwug3wi002ws7waa3v4z823",
        "fields": {
          "fileChecksum": "0971102a08ae20fa586e5195f7e02a059be4748dfc1e61a6c142560ab2c1aecc"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwug3ts002os7wawbmpf3jr",
        "fields": {
          "paymentStatus": "PARTIAL",
          "paidAmount": "98.00"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwug3v9002ss7wa9d0c052d",
        "fields": {
          "paymentStatus": "PAID",
          "paidAmount": "100.00"
        }
      },
      {
        "model": "BankTransaction",
        "id": "cmjwug3xv0030s7wajny3k17e",
        "fields": {
          "amount": "-5.00",
          "matchStatus": "AUTO_MATCHED"
        }
      },
      {
        "model": "BankTransaction",
        "id": "cmjwug3xv002ys7waynp4leeu",
        "fields": {
          "amount": "98.00",
          "matchStatus": "AUTO_MATCHED"
        }
      },
      {
        "model": "BankTransaction",
        "id": "cmjwug3xv002zs7wa7jc7mota",
        "fields": {
          "amount": "102.00",
          "matchStatus": "AUTO_MATCHED"
        }
      }
    ],
    "notes": {
      "matchRes": {
        "matchedCount": 3,
        "evaluated": 3
      }
    }
  }
}
{
  "correlationId": "SHATTER-S4",
  "step": "S4.Payroll→JOPPD→PDV",
  "input": {
    "payout": {
      "gross": "3000.00",
      "postalCode": "10000"
    },
    "ruleVersionIds": {
      "CONTRIBUTIONS": "cmjwug4a6003fs7wapdsiui4i",
      "INCOME_TAX": "cmjwug4at003hs7waomrnddco",
      "MUNICIPALITY_INCOME_TAX": "cmjwug4bk003js7waq0xa0t3u",
      "JOPPD_CODEBOOK": "cmjwug4ce003ls7waz8drggl7"
    },
    "joppd": {
      "mockSigning": true,
      "retentionYears": 11,
      "submissionId": "5dd572ba-a75d-44fe-b66e-de6fa5355a3e"
    },
    "sabotage": {
      "updateSignedKeyToNull": true,
      "deleteSubmission": true
    },
    "pdv": {
      "dateFrom": "2026-01-01T00:00:00.000Z",
      "dateTo": "2026-01-31T23:59:59.999Z"
    }
  },
  "process": [
    {
      "file": "src/lib/payroll/director-salary.ts",
      "fn": "computeDirectorSalaryPayroll"
    },
    {
      "file": "src/lib/joppd/joppd-service.ts",
      "fn": "prepareJoppdSubmission"
    },
    {
      "file": "src/lib/reports/pdv-xml-artifact.ts",
      "fn": "generatePdvXmlArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "Payout",
        "id": "3642b908-ff8b-40f8-b1db-a06efd34636a",
        "fields": {
          "status": "REPORTED",
          "periodMonth": 2
        }
      },
      {
        "model": "CalculationSnapshot",
        "id": "105be08e-23f5-4525-b021-f0188566f241",
        "fields": {
          "rulesEngineSnapshot": {
            "kind": "OPERATION_SHATTER_DIRECTOR_SALARY",
            "pinnedRuleVersions": {
              "INCOME_TAX": "cmjwug4at003hs7waomrnddco",
              "CONTRIBUTIONS": "cmjwug4a6003fs7wapdsiui4i",
              "MUNICIPALITY_INCOME_TAX": "cmjwug4bk003js7waq0xa0t3u"
            }
          }
        }
      },
      {
        "model": "JoppdSubmission",
        "id": "5dd572ba-a75d-44fe-b66e-de6fa5355a3e",
        "fields": {
          "status": "ACCEPTED",
          "signedXmlHash": "ad856e19498e2b1c675e611d02aab6f3eee4209484e0f7232a0c6e385db843b8",
          "signedXmlStorageKey": "attachments/cmjwug1r00001s7wazhm8un1e/2000/01/a76241fb_ad856e19498e2b1c675e611d02aab6f3eee4209484e0f7232a0c6e385db843b8.xml"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwug4j4003os7waf35gq1xz",
        "type": "XML",
        "fileName": "joppd-27187687622-2026-02-3642b908-ff8b-40f8-b1db-a06efd34636a.xml",
        "checksum": "ad856e19498e2b1c675e611d02aab6f3eee4209484e0f7232a0c6e385db843b8",
        "storageKey": "attachments/cmjwug1r00001s7wazhm8un1e/2000/01/a76241fb_ad856e19498e2b1c675e611d02aab6f3eee4209484e0f7232a0c6e385db843b8.xml",
        "generatorVersion": "joppd-xml@1",
        "inputHash": "87e3f988627b9b195a66d6b537620afb1bb618a6e5fdb8693fc5525e90fe1166"
      },
      {
        "id": "cmjwug4qe003ws7waog3awi39",
        "type": "XML",
        "fileName": "PDV-27187687622-2026-01.xml",
        "checksum": "da929f67c3f861fe02f216fd53bf5a8812a3e18e43d09b21affceed042065273",
        "storageKey": "attachments/cmjwug1r00001s7wazhm8un1e/2000/01/2fff286e_da929f67c3f861fe02f216fd53bf5a8812a3e18e43d09b21affceed042065273.xml",
        "generatorVersion": "pdv-xml@1",
        "inputHash": "8ba32e62d78e7afb60dc52f5d38b16a5f1a24407696021002b1d7752fba8e608"
      }
    ],
    "notes": {
      "joppdAttackError": "JoppdImmutabilityError: JOPPD submissions are immutable after signing/submission. Attempted to update fields [signedXmlStorageKey] on JOPPD in status ACCEPTED. Signed/submitted JOPPD records cannot be modified. Use a correction submission instead.",
      "joppdDeleteError": "JoppdImmutabilityError: JOPPD submissions are immutable after signing/submission. Cannot delete JOPPD in status ACCEPTED. Signed/submitted JOPPD records are immutable. Use a correction submission instead.",
      "pdv": {
        "section1": {
          "domestic": {
            "standard": {
              "rate": 25,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "reduced": {
              "rate": 13,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "superReduced": {
              "rate": 5,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            }
          },
          "euDeliveries": {
            "goods": "0.00",
            "services": "1000.00"
          },
          "exports": "0.00",
          "exempt": "0.00",
          "totalOutputVat": "0.00",
          "totalBaseOutput": "1000.00"
        },
        "section2": {
          "domestic": {
            "standard": {
              "rate": 25,
              "baseAmount": "2500.00",
              "vatAmount": "625.00"
            },
            "reduced": {
              "rate": 13,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "superReduced": {
              "rate": 5,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            }
          },
          "euAcquisitions": {
            "goods": {
              "rate": 25,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "services": {
              "rate": 25,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            }
          },
          "imports": {
            "rate": 25,
            "baseAmount": "0.00",
            "vatAmount": "0.00"
          },
          "nonDeductible": "0.00",
          "totalInputVat": "625.00",
          "totalBaseInput": "2500.00"
        },
        "section3": {
          "outputVat": "0.00",
          "inputVat": "625.00",
          "vatPayable": "-625.00"
        }
      }
    }
  }
}
{
  "done": true,
  "evidencePath": "/home/admin/FiskAI/.worktrees/operation-shatter/audit/operation-shatter/evidence/shatter-evidence.json"
}
