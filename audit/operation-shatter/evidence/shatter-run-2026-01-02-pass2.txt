{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice1 create + PDF",
  "input": {
    "buyer": {
      "name": "EU Client GmbH",
      "vatNumber": "DE123456789",
      "country": "DE"
    },
    "invoice": {
      "issueDate": "2026-01-05T00:00:00.000Z",
      "invoiceNumber": "1-1-1"
    },
    "lines": [
      {
        "description": "Consulting",
        "quantity": 1,
        "unitPrice": 1000,
        "vatRate": 0
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/invoice-numbering.ts",
      "fn": "getNextInvoiceNumber"
    },
    {
      "file": "src/lib/vat/output-calculator.ts",
      "fn": "buildVatLineTotals"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create"
    },
    {
      "file": "src/lib/pdf/generate-invoice-pdf-artifact.ts",
      "fn": "generateInvoicePdfArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtisag000cbrwaekdamscy",
        "fields": {
          "invoiceNumber": "1-1-1",
          "status": "SENT"
        }
      },
      {
        "model": "EInvoiceLine",
        "id": "cmjwtisav000dbrwa52fd7fr8",
        "fields": {
          "vatRate": "0.00",
          "vatAmount": "0.00"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwtiss3000gbrwanyuqw97z",
        "type": "PDF",
        "fileName": "racun-1-1-1.pdf",
        "checksum": "4849ed55384ce7dbec134137679685278bc20bd96f76582f81a6c837c1bacc46",
        "storageKey": "attachments/cmjwtis3e0001brwayeqzuuez/2000/01/2b4802c3_4849ed55384ce7dbec134137679685278bc20bd96f76582f81a6c837c1bacc46.pdf",
        "generatorVersion": "invoice-pdf@1",
        "inputHash": "a80a22e33a67b6a81034b0b9dfb72c39593c9ea71726b77112c3726ba3754774"
      }
    ],
    "notes": {
      "pdfContainsReverseChargeNote": false
    }
  }
}
{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice2 fiscalize + sabotage + credit note",
  "input": {
    "invoice2": {
      "invoiceNumber": "2-1-1",
      "totalAmount": "230.00"
    },
    "fiscalize": {
      "demo": true,
      "paymentMethod": "CASH"
    },
    "sabotage": {
      "update": {
        "totalAmount": "1.00"
      }
    },
    "creditNote": {
      "correctsInvoiceId": "cmjwtitc9000qbrwa0wkosu3w",
      "fullRefund": true
    }
  },
  "process": [
    {
      "file": "src/lib/fiscal/pos-fiscalize.ts",
      "fn": "fiscalizePosSale"
    },
    {
      "file": "src/lib/prisma-extensions.ts",
      "fn": "enforceInvoiceImmutability"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create (CREDIT_NOTE)"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtitc9000qbrwa0wkosu3w",
        "fields": {
          "jir": "DEMO-4f3fd7aab777c1f1f3c0da62f537dad6",
          "fiscalizedAt": "2026-01-02T11:56:18.845Z"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwtitg9000ybrwa5kw93386",
        "fields": {
          "correctsInvoiceId": "cmjwtitc9000qbrwa0wkosu3w",
          "totalAmount": "-230.00"
        }
      }
    ],
    "notes": {
      "sabotageError": "InvoiceImmutabilityError: Issued invoices are immutable. Attempted to update fields [totalAmount] on invoice in status PENDING_FISCALIZATION. Use a credit note for corrections."
    }
  }
}
