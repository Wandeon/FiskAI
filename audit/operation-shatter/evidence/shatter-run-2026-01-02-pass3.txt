{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice1 create + PDF",
  "input": {
    "buyer": {
      "name": "EU Client GmbH",
      "vatNumber": "DE123456789",
      "country": "DE"
    },
    "invoice": {
      "issueDate": "2026-01-05T00:00:00.000Z",
      "invoiceNumber": "1-1-1"
    },
    "lines": [
      {
        "description": "Consulting",
        "quantity": 1,
        "unitPrice": 1000,
        "vatRate": 0
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/invoice-numbering.ts",
      "fn": "getNextInvoiceNumber"
    },
    {
      "file": "src/lib/vat/output-calculator.ts",
      "fn": "buildVatLineTotals"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create"
    },
    {
      "file": "src/lib/pdf/generate-invoice-pdf-artifact.ts",
      "fn": "generateInvoicePdfArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtkbmq000ceqwal89m2gyi",
        "fields": {
          "invoiceNumber": "1-1-1",
          "status": "SENT"
        }
      },
      {
        "model": "EInvoiceLine",
        "id": "cmjwtkbn1000deqwa0un17htj",
        "fields": {
          "vatRate": "0.00",
          "vatAmount": "0.00"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwtkc34000geqwa69nfpd5r",
        "type": "PDF",
        "fileName": "racun-1-1-1.pdf",
        "checksum": "2f5e6e3ee2eaa1a6806ffd5bc6670b9d04b2d55aeae91079321ab50eef1ae397",
        "storageKey": "attachments/cmjwtkbeo0001eqwae9ujzobv/2000/01/7d7bdacd_2f5e6e3ee2eaa1a6806ffd5bc6670b9d04b2d55aeae91079321ab50eef1ae397.pdf",
        "generatorVersion": "invoice-pdf@1",
        "inputHash": "eb5cc652abf76cc6ddb7437a3b35dd611387528846ba6c5434f99f4cf608c596"
      }
    ],
    "notes": {
      "pdfContainsReverseChargeNote": false
    }
  }
}
{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice2 fiscalize + sabotage + credit note",
  "input": {
    "invoice2": {
      "invoiceNumber": "2-1-1",
      "totalAmount": "230.00"
    },
    "fiscalize": {
      "demo": true,
      "paymentMethod": "CASH"
    },
    "sabotage": {
      "update": {
        "totalAmount": "1.00"
      }
    },
    "creditNote": {
      "correctsInvoiceId": "cmjwtkcmw000qeqwa0emevwaw",
      "fullRefund": true
    }
  },
  "process": [
    {
      "file": "src/lib/fiscal/pos-fiscalize.ts",
      "fn": "fiscalizePosSale"
    },
    {
      "file": "src/lib/prisma-extensions.ts",
      "fn": "enforceInvoiceImmutability"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create (CREDIT_NOTE)"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtkcmw000qeqwa0emevwaw",
        "fields": {
          "jir": "DEMO-b124462cd3295e359c8ea1cb082c7412",
          "fiscalizedAt": "2026-01-02T11:57:30.534Z"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwtkcty000yeqwaw0bto5bp",
        "fields": {
          "correctsInvoiceId": "cmjwtkcmw000qeqwa0emevwaw",
          "totalAmount": "-230.00"
        }
      }
    ],
    "notes": {
      "sabotageError": "InvoiceImmutabilityError: Issued invoices are immutable. Attempted to update fields [totalAmount] on invoice in status PENDING_FISCALIZATION. Use a credit note for corrections."
    }
  }
}
