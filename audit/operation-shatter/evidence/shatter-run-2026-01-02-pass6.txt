{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice1 create + PDF",
  "input": {
    "buyer": {
      "name": "EU Client GmbH",
      "vatNumber": "DE123456789",
      "country": "DE"
    },
    "invoice": {
      "issueDate": "2026-01-05T00:00:00.000Z",
      "invoiceNumber": "1-1-1"
    },
    "lines": [
      {
        "description": "Consulting",
        "quantity": 1,
        "unitPrice": 1000,
        "vatRate": 0
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/invoice-numbering.ts",
      "fn": "getNextInvoiceNumber"
    },
    {
      "file": "src/lib/vat/output-calculator.ts",
      "fn": "buildVatLineTotals"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create"
    },
    {
      "file": "src/lib/pdf/generate-invoice-pdf-artifact.ts",
      "fn": "generateInvoicePdfArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtqhp6000cttwa4ft84zkq",
        "fields": {
          "invoiceNumber": "1-1-1",
          "status": "SENT"
        }
      },
      {
        "model": "EInvoiceLine",
        "id": "cmjwtqhpd000dttwaju6xzyqo",
        "fields": {
          "vatRate": "0.00",
          "vatAmount": "0.00"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwtqi84000gttwa53j6meh9",
        "type": "PDF",
        "fileName": "racun-1-1-1.pdf",
        "checksum": "9994f1aa50578bfaffe5493f21b44aec32bf3b3ce939e6e43fe2ff5753a60a10",
        "storageKey": "attachments/cmjwtqhi60001ttwacgxs2cg6/2000/01/f5f2ca9d_9994f1aa50578bfaffe5493f21b44aec32bf3b3ce939e6e43fe2ff5753a60a10.pdf",
        "generatorVersion": "invoice-pdf@1",
        "inputHash": "3d34681a5faeb9b3c587f833886c13390ea759a8d9d84bd3ee02e91875f7ab9e"
      }
    ],
    "notes": {
      "pdfContainsReverseChargeNote": false
    }
  }
}
{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice2 fiscalize + sabotage + credit note",
  "input": {
    "invoice2": {
      "invoiceNumber": "2-1-1",
      "totalAmount": "230.00"
    },
    "fiscalize": {
      "demo": true,
      "paymentMethod": "CASH"
    },
    "sabotage": {
      "update": {
        "totalAmount": "1.00"
      }
    },
    "creditNote": {
      "correctsInvoiceId": "cmjwtqiq5000qttwa7f5e364e",
      "fullRefund": true
    }
  },
  "process": [
    {
      "file": "src/lib/fiscal/pos-fiscalize.ts",
      "fn": "fiscalizePosSale"
    },
    {
      "file": "src/lib/prisma-extensions.ts",
      "fn": "enforceInvoiceImmutability"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create (CREDIT_NOTE)"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtqiq5000qttwa7f5e364e",
        "fields": {
          "jir": "DEMO-48361b6384aacc8aa20931bea4e208d6",
          "fiscalizedAt": "2026-01-02T12:02:18.340Z"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwtqiul000yttwabcprpsl5",
        "fields": {
          "correctsInvoiceId": "cmjwtqiq5000qttwa7f5e364e",
          "totalAmount": "-230.00"
        }
      }
    ],
    "notes": {
      "sabotageError": "InvoiceImmutabilityError: Issued invoices are immutable. Attempted to update fields [totalAmount] on invoice in status PENDING_FISCALIZATION. Use a credit note for corrections."
    }
  }
}
{
  "correlationId": "SHATTER-S2",
  "step": "S2.Expense→Asset→MonthClose→Lock",
  "input": {
    "expense": {
      "vendor": "Links d.o.o.",
      "item": "MacBook Pro M3",
      "net": "2500.00",
      "vat": "625.00",
      "total": "3125.00"
    },
    "depreciation": {
      "usefulLifeMonths": 24,
      "expectedMonth1": "104.16"
    },
    "monthClose": {
      "month": "2026-01"
    },
    "sabotage": {
      "expenseUpdateDescription": "Tampered"
    }
  },
  "process": [
    {
      "file": "src/lib/fixed-assets/asset-candidates.ts",
      "fn": "emitAssetCandidates"
    },
    {
      "file": "src/lib/fixed-assets/conversion.ts",
      "fn": "convertFixedAssetCandidateToAsset"
    },
    {
      "file": "src/lib/assets/depreciation.ts",
      "fn": "postDepreciationEntriesForPeriod"
    },
    {
      "file": "src/lib/month-close/service.ts",
      "fn": "runMonthClose"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "Expense",
        "id": "cmjwtqix20016ttwaplx9z5e4",
        "fields": {
          "totalAmount": "3125.00",
          "status": "PENDING"
        }
      },
      {
        "model": "FixedAssetCandidate",
        "id": "cmjwtqj0f001ettwa2kmunc19",
        "fields": {
          "status": "PENDING",
          "amount": "3125.00",
          "thresholdValue": "464.53"
        }
      },
      {
        "model": "FixedAsset",
        "id": "cmjwtqj20001fttwa2u5y4fwa",
        "fields": {
          "acquisitionCost": "2500.00",
          "usefulLifeMonths": 24
        }
      },
      {
        "model": "AccountingPeriod",
        "id": "cmjwtqj5v0027ttwaghzy8jmi",
        "fields": {
          "status": "LOCKED",
          "startDate": "2025-12-31T23:00:00.000Z"
        }
      }
    ],
    "notes": {
      "lockError": "AccountingPeriodLockedError: Cannot modify Expense on 2026-01-10T00:00:00.000Z: accounting period is locked."
    }
  }
}
