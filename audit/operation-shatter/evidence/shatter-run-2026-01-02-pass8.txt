{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice1 create + PDF",
  "input": {
    "buyer": {
      "name": "EU Client GmbH",
      "vatNumber": "DE123456789",
      "country": "DE"
    },
    "invoice": {
      "issueDate": "2026-01-05T00:00:00.000Z",
      "invoiceNumber": "1-1-1"
    },
    "lines": [
      {
        "description": "Consulting",
        "quantity": 1,
        "unitPrice": 1000,
        "vatRate": 0
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/invoice-numbering.ts",
      "fn": "getNextInvoiceNumber"
    },
    {
      "file": "src/lib/vat/output-calculator.ts",
      "fn": "buildVatLineTotals"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create"
    },
    {
      "file": "src/lib/pdf/generate-invoice-pdf-artifact.ts",
      "fn": "generateInvoicePdfArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtv3mv000cvfwav7wpgttd",
        "fields": {
          "invoiceNumber": "1-1-1",
          "status": "SENT"
        }
      },
      {
        "model": "EInvoiceLine",
        "id": "cmjwtv3n0000dvfwabuid1byv",
        "fields": {
          "vatRate": "0.00",
          "vatAmount": "0.00"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwtv48x000gvfwapzwb8jhu",
        "type": "PDF",
        "fileName": "racun-1-1-1.pdf",
        "checksum": "8c52d910605ab700b1684087b6e6f22e40f33fdba42180141d21594c0a798b1d",
        "storageKey": "attachments/cmjwtv3fz0001vfwar5agmbii/2000/01/f7d2a426_8c52d910605ab700b1684087b6e6f22e40f33fdba42180141d21594c0a798b1d.pdf",
        "generatorVersion": "invoice-pdf@1",
        "inputHash": "81710b33ab5d75a04be09a751681c8a233778e8b1bc9dd0dad3138e112890770"
      }
    ],
    "notes": {
      "pdfContainsReverseChargeNote": true
    }
  }
}
{
  "correlationId": "SHATTER-S1",
  "step": "S1.Invoice2 fiscalize + sabotage + credit note",
  "input": {
    "invoice2": {
      "invoiceNumber": "2-1-1",
      "totalAmount": "230.00"
    },
    "fiscalize": {
      "demo": true,
      "paymentMethod": "CASH"
    },
    "sabotage": {
      "update": {
        "totalAmount": "1.00"
      }
    },
    "creditNote": {
      "correctsInvoiceId": "cmjwtv4sy000qvfwaqg6pvsva",
      "fullRefund": true
    }
  },
  "process": [
    {
      "file": "src/lib/fiscal/pos-fiscalize.ts",
      "fn": "fiscalizePosSale"
    },
    {
      "file": "src/lib/prisma-extensions.ts",
      "fn": "enforceInvoiceImmutability"
    },
    {
      "file": "scripts/operation-shatter.ts",
      "fn": "db.eInvoice.create (CREDIT_NOTE)"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "EInvoice",
        "id": "cmjwtv4sy000qvfwaqg6pvsva",
        "fields": {
          "jir": "DEMO-87b6e4a9bb2a823dc446d13c006e3f75",
          "fiscalizedAt": "2026-01-02T12:05:53.573Z"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwtv4xo000yvfwannc6tqfy",
        "fields": {
          "correctsInvoiceId": "cmjwtv4sy000qvfwaqg6pvsva",
          "totalAmount": "-230.00"
        }
      }
    ],
    "notes": {
      "sabotageError": "InvoiceImmutabilityError: Issued invoices are immutable. Attempted to update fields [totalAmount] on invoice in status PENDING_FISCALIZATION. Use a credit note for corrections."
    }
  }
}
{
  "correlationId": "SHATTER-S2",
  "step": "S2.Expense→Asset→MonthClose→Lock",
  "input": {
    "expense": {
      "vendor": "Links d.o.o.",
      "item": "MacBook Pro M3",
      "net": "2500.00",
      "vat": "625.00",
      "total": "3125.00"
    },
    "depreciation": {
      "usefulLifeMonths": 24,
      "expectedMonth1": "104.16"
    },
    "monthClose": {
      "month": "2026-01"
    },
    "sabotage": {
      "expenseUpdateDescription": "Tampered"
    }
  },
  "process": [
    {
      "file": "src/lib/fixed-assets/asset-candidates.ts",
      "fn": "emitAssetCandidates"
    },
    {
      "file": "src/lib/fixed-assets/conversion.ts",
      "fn": "convertFixedAssetCandidateToAsset"
    },
    {
      "file": "src/lib/assets/depreciation.ts",
      "fn": "postDepreciationEntriesForPeriod"
    },
    {
      "file": "src/lib/month-close/service.ts",
      "fn": "runMonthClose"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "Expense",
        "id": "cmjwtv5090017vfwa9hvw1r9n",
        "fields": {
          "totalAmount": "3125.00",
          "status": "PENDING"
        }
      },
      {
        "model": "FixedAssetCandidate",
        "id": "cmjwtv52c001evfwaxlyqsih7",
        "fields": {
          "status": "PENDING",
          "amount": "3125.00",
          "thresholdValue": "464.53"
        }
      },
      {
        "model": "FixedAsset",
        "id": "cmjwtv535001fvfwa4w4thops",
        "fields": {
          "acquisitionCost": "2500.00",
          "usefulLifeMonths": 24
        }
      },
      {
        "model": "AccountingPeriod",
        "id": "cmjwtv56p0027vfwa2gz3eh0e",
        "fields": {
          "status": "LOCKED",
          "startDate": "2025-12-31T23:00:00.000Z"
        }
      }
    ],
    "notes": {
      "lockError": "AccountingPeriodLockedError: Cannot modify Expense on 2026-01-10T00:00:00.000Z: accounting period is locked."
    }
  }
}
{
  "correlationId": "SHATTER-S3",
  "step": "S3.Import + AutoMatch",
  "input": {
    "invoices": [
      {
        "id": "cmjwtv5dq002lvfwaynguf8b2",
        "invoiceNumber": "4-1-1",
        "total": "100.00"
      },
      {
        "id": "cmjwtv5f6002pvfwabg58m123",
        "invoiceNumber": "5-1-1",
        "total": "100.00"
      }
    ],
    "transactions": [
      {
        "amount": "98.00",
        "reference": null
      },
      {
        "amount": "102.00",
        "reference": "5-1-1"
      },
      {
        "amount": "-5.00",
        "description": "Bank naknada"
      }
    ]
  },
  "process": [
    {
      "file": "src/lib/banking/import/import-parsed.ts",
      "fn": "importParsedBankTransactions"
    },
    {
      "file": "src/lib/banking/reconciliation-service.ts",
      "fn": "runAutoMatchTransactions"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "StatementImport",
        "id": "cmjwtv5hs002tvfwacm52d3vp",
        "fields": {
          "fileChecksum": "843e8103fd6bf38354a31b3f15a552ad60b4b18962c537d36fc2f80c6a01bbb5"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwtv5dq002lvfwaynguf8b2",
        "fields": {
          "paymentStatus": "PARTIAL",
          "paidAmount": "98.00"
        }
      },
      {
        "model": "EInvoice",
        "id": "cmjwtv5f6002pvfwabg58m123",
        "fields": {
          "paymentStatus": "PAID",
          "paidAmount": "100.00"
        }
      },
      {
        "model": "BankTransaction",
        "id": "cmjwtv5j3002xvfwarmf8p7yp",
        "fields": {
          "amount": "-5.00",
          "matchStatus": "AUTO_MATCHED"
        }
      },
      {
        "model": "BankTransaction",
        "id": "cmjwtv5j3002vvfwaf3ukwcnh",
        "fields": {
          "amount": "98.00",
          "matchStatus": "AUTO_MATCHED"
        }
      },
      {
        "model": "BankTransaction",
        "id": "cmjwtv5j3002wvfwa13jy58we",
        "fields": {
          "amount": "102.00",
          "matchStatus": "AUTO_MATCHED"
        }
      }
    ],
    "notes": {
      "matchRes": {
        "matchedCount": 3,
        "evaluated": 3
      }
    }
  }
}
{
  "correlationId": "SHATTER-S4",
  "step": "S4.Payroll→JOPPD→PDV",
  "input": {
    "payout": {
      "gross": "3000.00",
      "postalCode": "10000"
    },
    "ruleVersionIds": {
      "CONTRIBUTIONS": "cmjwtv5x1003cvfwaucuouwf3",
      "INCOME_TAX": "cmjwtv5y1003evfwaan20jfye",
      "MUNICIPALITY_INCOME_TAX": "cmjwtv5yk003gvfwa3hnviejd",
      "JOPPD_CODEBOOK": "cmjwtv5z1003ivfwa5jxlcyc0"
    },
    "joppd": {
      "mockSigning": true,
      "retentionYears": 11,
      "submissionId": "73e17b98-84bb-4785-ae8d-5a2927d6b86f"
    },
    "sabotage": {
      "updateSignedKeyToNull": true,
      "deleteSubmission": true
    },
    "pdv": {
      "dateFrom": "2026-01-01T00:00:00.000Z",
      "dateTo": "2026-01-31T23:59:59.999Z"
    }
  },
  "process": [
    {
      "file": "src/lib/payroll/director-salary.ts",
      "fn": "computeDirectorSalaryPayroll"
    },
    {
      "file": "src/lib/joppd/joppd-service.ts",
      "fn": "prepareJoppdSubmission"
    },
    {
      "file": "src/lib/reports/pdv-xml-artifact.ts",
      "fn": "generatePdvXmlArtifact"
    }
  ],
  "evidence": {
    "rows": [
      {
        "model": "Payout",
        "id": "5021d03c-8796-4ad6-a3bc-c452f3155129",
        "fields": {
          "status": "REPORTED",
          "periodMonth": 2
        }
      },
      {
        "model": "CalculationSnapshot",
        "id": "03484940-c03b-4cf4-8582-5ad813423c72",
        "fields": {
          "rulesEngineSnapshot": {
            "kind": "OPERATION_SHATTER_DIRECTOR_SALARY",
            "pinnedRuleVersions": {
              "INCOME_TAX": "cmjwtv5y1003evfwaan20jfye",
              "CONTRIBUTIONS": "cmjwtv5x1003cvfwaucuouwf3",
              "MUNICIPALITY_INCOME_TAX": "cmjwtv5yk003gvfwa3hnviejd"
            }
          }
        }
      },
      {
        "model": "JoppdSubmission",
        "id": "73e17b98-84bb-4785-ae8d-5a2927d6b86f",
        "fields": {
          "status": "ACCEPTED",
          "signedXmlHash": "4fd8eb595856021813fdeb835685e102403417781f4dfe92c42415b76f1dc8ab",
          "signedXmlStorageKey": "attachments/cmjwtv3fz0001vfwar5agmbii/2000/01/f7683785_4fd8eb595856021813fdeb835685e102403417781f4dfe92c42415b76f1dc8ab.xml"
        }
      }
    ],
    "artifacts": [
      {
        "id": "cmjwtv67p003lvfwa73udv4ki",
        "type": "XML",
        "fileName": "joppd-31237420670-2026-02-5021d03c-8796-4ad6-a3bc-c452f3155129.xml",
        "checksum": "4fd8eb595856021813fdeb835685e102403417781f4dfe92c42415b76f1dc8ab",
        "storageKey": "attachments/cmjwtv3fz0001vfwar5agmbii/2000/01/f7683785_4fd8eb595856021813fdeb835685e102403417781f4dfe92c42415b76f1dc8ab.xml",
        "generatorVersion": "joppd-xml@1",
        "inputHash": "31965402d3705238bd7a0e68f392e7083e3dcbcd33279dbf7a40f9cb93dc1a24"
      },
      {
        "id": "cmjwtv6gx003tvfwa425uf8q7",
        "type": "XML",
        "fileName": "PDV-31237420670-2026-01.xml",
        "checksum": "1f47109f0af59ea78004de7b46caeac7026a306337e64bb2037ac6e34a8f6b21",
        "storageKey": "attachments/cmjwtv3fz0001vfwar5agmbii/2000/01/45781a44_1f47109f0af59ea78004de7b46caeac7026a306337e64bb2037ac6e34a8f6b21.xml",
        "generatorVersion": "pdv-xml@1",
        "inputHash": "1eed9eba1cf38106a28665180593374a99103e3a97450a7892dd38c0a93c9256"
      }
    ],
    "notes": {
      "joppdAttackError": "JoppdImmutabilityError: JOPPD submissions are immutable after signing/submission. Attempted to update fields [signedXmlStorageKey] on JOPPD in status ACCEPTED. Signed/submitted JOPPD records cannot be modified. Use a correction submission instead.",
      "joppdDeleteError": "JoppdImmutabilityError: JOPPD submissions are immutable after signing/submission. Cannot delete JOPPD in status ACCEPTED. Signed/submitted JOPPD records are immutable. Use a correction submission instead.",
      "pdv": {
        "section1": {
          "domestic": {
            "standard": {
              "rate": 25,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "reduced": {
              "rate": 13,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "superReduced": {
              "rate": 5,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            }
          },
          "euDeliveries": {
            "goods": "0.00",
            "services": "1000.00"
          },
          "exports": "0.00",
          "exempt": "0.00",
          "totalOutputVat": "0.00",
          "totalBaseOutput": "1000.00"
        },
        "section2": {
          "domestic": {
            "standard": {
              "rate": 25,
              "baseAmount": "2500.00",
              "vatAmount": "625.00"
            },
            "reduced": {
              "rate": 13,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "superReduced": {
              "rate": 5,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            }
          },
          "euAcquisitions": {
            "goods": {
              "rate": 25,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            },
            "services": {
              "rate": 25,
              "baseAmount": "0.00",
              "vatAmount": "0.00"
            }
          },
          "imports": {
            "rate": 25,
            "baseAmount": "0.00",
            "vatAmount": "0.00"
          },
          "nonDeductible": "0.00",
          "totalInputVat": "625.00",
          "totalBaseInput": "2500.00"
        },
        "section3": {
          "outputVat": "0.00",
          "inputVat": "625.00",
          "vatPayable": "-625.00"
        }
      }
    }
  }
}
{
  "done": true,
  "evidencePath": "/home/admin/FiskAI/.worktrees/operation-shatter/audit/operation-shatter/evidence/shatter-evidence.json"
}
