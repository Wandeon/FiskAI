# Work Log – 2025-02-14

## Changes Implemented
1. **CI pipeline** – Added `.github/workflows/ci.yml` running npm install, Prisma generate/validate, lint, and build on pushes/PRs.
2. **Accessibility baseline fixes**
   - Set default document language to Croatian in `src/app/layout.tsx`.
   - Enhanced `src/components/ui/input.tsx` to announce validation errors via ARIA attributes and `role="alert"`.
   - Labeled the buyer select on the new invoice form with `htmlFor/id`, ARIA states, and error messaging in `src/app/(dashboard)/e-invoices/new/page.tsx`.
   - Added table caption/scope semantics for the invoice list in `src/app/(dashboard)/e-invoices/page.tsx`.

## Notes
- These updates correspond to items raised in `audit/accessibility-audit.md` and the DevEx audit.
- No database schema changes were performed; migrations remain untouched.
- README now includes a "Maintenance Log" summarizing these tasks for team visibility.

## Afternoon Session
1. **Tenant integrity safeguards**
   - Updated `prisma/schema.prisma` with unique constraints on `(companyId, oib)` and `(companyId, invoiceNumber)`; added manual migration at `prisma/migrations/202502141200_add_tenant_constraints/migration.sql` (requires deploy via `prisma migrate deploy`).
   - Regenerated Prisma Client after schema change (`npx prisma generate`).
2. **Server-side ownership checks** – `src/app/actions/e-invoice.ts` now verifies the selected buyer belongs to the active company before creating an invoice.
3. **Dependencies** – Installed project npm dependencies to enable Prisma generation/linting.
4. **CI lint run** – Executed `npm run lint` (warnings only) to verify the tree; see terminal output for ESLint warnings to triage later.

**Notes:** Database currently shows drift (legacy schema without migrations). Applying the new migration requires running `prisma migrate deploy` (or equivalent) against the target database once it’s aligned/clean. Clean up duplicate invoice numbers/contacts before applying to avoid failures.

## Secrets & Compose cleanup
1. **docker-compose.yml** now relies on environment variable substitution (no hard-coded credentials, removed `AUTH_TRUST_HOST`).
2. Added `.env.example` documenting required variables for local/dev deployments.
3. Updated README with environment setup instructions + maintenance note.

## Provider secret hardening
1. Replaced plain-text `Company.eInvoiceApiKey` with encrypted storage (`eInvoiceApiKeyEncrypted`) and added Prisma migration (`prisma/migrations/202502141215_encrypt_provider_keys`).
2. Added AES-256-GCM helper (`src/lib/secrets.ts`) with `EINVOICE_KEY_SECRET` environment requirement.
3. Updated company settings action to encrypt/decrypt API keys and allow clearing them; e-invoice sending now decrypts before calling providers.
4. Added `.env.example` + README/docker-compose entries for `EINVOICE_KEY_SECRET`.

## UX – Company context
1. Header now displays a company switcher fed from `db.companyUser` (server component fetch). Users can switch tenants directly; default selection reflects `isDefault`. (`src/components/layout/header.tsx`)
2. Added `switchCompanyAction` server action for form submissions wrapping existing logic (`src/app/actions/company.ts`).
