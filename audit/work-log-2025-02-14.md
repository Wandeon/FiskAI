# Work Log – 2025-02-14

## Changes Implemented
1. **CI pipeline** – Added `.github/workflows/ci.yml` running npm install, Prisma generate/validate, lint, and build on pushes/PRs.
2. **Accessibility baseline fixes**
   - Set default document language to Croatian in `src/app/layout.tsx`.
   - Enhanced `src/components/ui/input.tsx` to announce validation errors via ARIA attributes and `role="alert"`.
   - Labeled the buyer select on the new invoice form with `htmlFor/id`, ARIA states, and error messaging in `src/app/(dashboard)/e-invoices/new/page.tsx`.
   - Added table caption/scope semantics for the invoice list in `src/app/(dashboard)/e-invoices/page.tsx`.

## Notes
- These updates correspond to items raised in `audit/accessibility-audit.md` and the DevEx audit.
- No database schema changes were performed; migrations remain untouched.
- README now includes a "Maintenance Log" summarizing these tasks for team visibility.

## Afternoon Session
1. **Tenant integrity safeguards**
   - Updated `prisma/schema.prisma` with unique constraints on `(companyId, oib)` and `(companyId, invoiceNumber)`; added manual migration at `prisma/migrations/202502141200_add_tenant_constraints/migration.sql` (requires deploy via `prisma migrate deploy`).
   - Regenerated Prisma Client after schema change (`npx prisma generate`).
2. **Server-side ownership checks** – `src/app/actions/e-invoice.ts` now verifies the selected buyer belongs to the active company before creating an invoice.
3. **Dependencies** – Installed project npm dependencies to enable Prisma generation/linting.
4. **CI lint run** – Executed `npm run lint` (warnings only) to verify the tree; see terminal output for ESLint warnings to triage later.

**Notes:** Database currently shows drift (legacy schema without migrations). Applying the new migration requires running `prisma migrate deploy` (or equivalent) against the target database once it’s aligned/clean. Clean up duplicate invoice numbers/contacts before applying to avoid failures.

## Secrets & Compose cleanup
1. **docker-compose.yml** now relies on environment variable substitution (no hard-coded credentials, removed `AUTH_TRUST_HOST`).
2. Added `.env.example` documenting required variables for local/dev deployments.
3. Updated README with environment setup instructions + maintenance note.

## Provider secret hardening
1. Replaced plain-text `Company.eInvoiceApiKey` with encrypted storage (`eInvoiceApiKeyEncrypted`) and added Prisma migration (`prisma/migrations/202502141215_encrypt_provider_keys`).
2. Added AES-256-GCM helper (`src/lib/secrets.ts`) with `EINVOICE_KEY_SECRET` environment requirement.
3. Updated company settings action to encrypt/decrypt API keys and allow clearing them; e-invoice sending now decrypts before calling providers.
4. Added `.env.example` + README/docker-compose entries for `EINVOICE_KEY_SECRET`.

## UX – Company context
1. Header now displays a company switcher fed from `db.companyUser` (server component fetch). Users can switch tenants directly; default selection reflects `isDefault`. (`src/components/layout/header.tsx`)
2. Added `switchCompanyAction` server action for form submissions wrapping existing logic (`src/app/actions/company.ts`).

## Coolify deployment notes
- Added `docs/infrastructure/coolify-setup.md` detailing prerequisites, installation, and configuration steps to host FiskAI on Coolify (ARM64).
- Linked the new guide from README for quick access.

## Coolify installation
- Ran `sudo apt update && sudo apt upgrade -y` to prep the VPS.
- Installed Coolify via official script (`curl -fsSL https://cdn.coollabs.io/coolify/install.sh | sudo bash`).
- Coolify v4.0.0-beta.453 is now running on port 8000. Access URLs reported by installer:
  - IPv4: http://152.53.146.3:8000
  - IPv6: http://[2a0a:4cc0:c1:2750:a804:a6ff:fe84:e68f]:8000
  - Private: http://172.18.0.1:8000 (and other addresses printed above).
- Next steps: visit the URL to create the admin account, set DNS/HTTPS, and onboard FiskAI per `docs/infrastructure/coolify-setup.md`.
- Created root Coolify admin via scripted POST (email: admin@example.com). Onboarding UI still needs manual completion through the browser (server registration, DNS, GitHub link, etc.).
- Restored missing deployment assets (`Dockerfile`, `docker-compose.yml`, empty `public/`) and seeded `.env.production` for Compose.
- Rebuilt and relaunched the legacy Docker stack via `docker compose --env-file .env.production up -d`; app is again reachable through Caddy at https://erp.metrica.hr (307 redirect observed).
- Added Caddy reverse proxy block for `git.metrica.hr` pointing to Coolify on localhost:8000, then reloaded Caddy. DNS already points to the VPS, so Coolify is now reachable at https://git.metrica.hr.
- Added a global command palette (`src/components/ui/command-palette.tsx`) with ⌘K/ctrl+K support, plus a header trigger for quick navigation across modules.
- Added responsive mobile bottom navigation (`src/components/layout/bottom-nav.tsx`) and wired it into the dashboard layout for frictionless phone navigation.
- Connected the command palette to the mobile shell (floating trigger) and added quick-filter buttons on the Contacts page for faster segmentation.
- Polished the multi-step e-invoice composer: added autosave timestamp indicator, contextual helper text, and sticky mobile action controls so users can navigate steps and save drafts from phones.
- Added PDF-style preview and download shortcut for the e-invoice composer (`InvoicePdfPreview` + print-to-PDF helper) and ensured the server-side page passes company data down to the form.
- Dashboard refresh: Added `HeroBanner`, revenue trend visualization, action cards, and reorganized the layout (trend data aggregation, onboarding grid) per UI plan.

## Notification center wiring
1. Created shared notification types (`src/types/notifications.ts`) and updated the bell dropdown (`src/components/ui/notification-center.tsx`) plus `HeaderActions` wiring to consume typed items instead of placeholders.
2. Added `src/lib/notifications.ts`, aggregating tenant-scoped invoice stats and audit logs (with relative timestamps + CTA links) for the header.
3. Header server component now fetches company notifications via `getNotificationCenterFeed`, counts unread items using `CompanyUser.notificationSeenAt`, and injects the payload into the bell trigger (`src/components/layout/header.tsx`, `src/components/layout/header-actions.tsx`).
4. Introduced `/api/notifications` + `/api/notifications/read` endpoints for polling + read receipts, added client-side refresh (60 s) and badge updates, and created Prisma migration `202502150900_add_notification_seen` adding `notificationSeenAt` on `CompanyUser` for per-tenant unread tracking.

## Products table filters
1. Added `ProductTable` client component (`src/components/products/product-table.tsx`) with search, VAT/status multi-select filters, active counts, and responsive table styling.
2. Wired the Products dashboard page to feed normalized product data + VAT options into the new component and preserved the empty-state CTA for first-time users (`src/app/(dashboard)/products/page.tsx`).

## Settings navigation refresh
1. Converted `/settings` into a tabbed layout (query param `tab`) with a contextual sidebar and quick links to premises/audit log (`src/app/(dashboard)/settings/page.tsx`).
2. Split content into Tvrtka / E-računi / Usklađenost panels, added status cards + deadline reminders, and kept company/e-invoice forms intact for their respective tabs.

## Header onboarding pill
1. Added `OnboardingProgressPill` (`src/components/layout/onboarding-progress-pill.tsx`) showing step completion, CTA to resume onboarding, and a quick invite link for accountants.
2. Header server component now computes onboarding progress from contact/product/invoice counts and renders the pill next to the company switcher on large screens (`src/components/layout/header.tsx`).

## Invoices filtering
1. Introduced `InvoiceFilters` (`src/components/invoices/invoice-filters.tsx`) with search, multi-select type/status filters, and clear/apply actions tied to URL params.
2. Updated the invoices list to parse multi-value filters, add buyer/name search, include filters in pagination links, and keep server queries tenant-scoped (`src/app/(dashboard)/invoices/page.tsx`).

## Expenses filtering
1. Added `ExpenseFilters` (`src/components/expenses/expense-filters.tsx`) delivering status/category multi-selects plus vendor/description search.
2. Expenses index now parses multi-value params, adds OR search across vendor/description/OIB, and preserves filters when paginating (`src/app/(dashboard)/expenses/page.tsx`).

## Logging improvements
1. Introduced `withApiLogging` (`src/lib/api-logging.ts`) which wraps API route handlers with AsyncLocalStorage context, duration tracking, and structured success/error logs (including request IDs).
2. Added `updateContext` helper so routes/actions can attach user/company info (`src/lib/context.ts`).
3. Wrapped AI, notification, metrics, and health endpoints with the new logging helper and swapped `console.error` calls with `logger.error`, ensuring context is populated after auth (`src/app/api/**/route.ts`).

## Expenses responsive table
1. Replaced the expenses list `DataTable` with the shared `ResponsiveTable`, enabling mobile card rendering with amount/status badges and quick detail links (`src/app/(dashboard)/expenses/page.tsx`).
2. Added formatted currency helper so totals stay localized across both desktop columns and cards.

## Invoices responsive table
1. Converted the invoices list to `ResponsiveTable`, retaining desktop columns while adding mobile cards with invoice number, buyer, amount, type/status chips, and "Detalji" links (`src/app/(dashboard)/invoices/page.tsx`).
2. Introduced shared currency formatter for invoice totals to keep formatting consistent across views.

## Banking transactions responsive table
1. Swapped the DataTable on `/banking/transactions` for `ResponsiveTable`, rendering mobile cards with amount color coding, account info, match status chips, and quick “Poveži” buttons (`src/app/(dashboard)/banking/transactions/page.tsx`).
2. Added helper utilities for pagination link building and currency formatting to keep filters + navigation intact on the transactions list.
