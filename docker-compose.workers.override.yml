# Override to use external Redis (fiskai-redis-vps)
x-worker-common: &worker-common
  image: fiskai-worker:dev
  restart: unless-stopped
  networks:
    - redis_default
    - coolify
  environment: &worker-env
    NODE_ENV: production
    REDIS_URL: redis://default:5a42cf3f43b0fe332f10ca17ff4c2931cab329fb486dd663304ae7b39f3a7e0a@fiskai-redis-vps:6379
    DATABASE_URL: postgresql://fiskai:fiskai_secret_2025@100.64.123.81:5434/fiskai?schema=public
    REGULATORY_DATABASE_URL: postgresql://fiskai:fiskai_secret_2025@100.64.123.81:5434/fiskai?schema=regulatory
    # Pipeline mode kill switch: PHASE_D | LEGACY | OFF
    # Set to OFF during maintenance, PHASE_D for new CandidateFact pipeline
    RTL_PIPELINE_MODE: "PHASE_D"
    # Cloud Ollama - all LLM reasoning tasks (gemini-3-flash-preview for quality)
    OLLAMA_ENDPOINT: https://ollama.com
    OLLAMA_API_KEY: 58505c47a1a34af189303b7fe23e3e10.UBHoZckgsmj88-z90aFo-OEE
    OLLAMA_MODEL: gemini-3-flash-preview
    # Local Ollama (GPU-01) - embeddings only
    OLLAMA_EMBED_ENDPOINT: http://100.100.47.43:11434
    OLLAMA_EMBED_MODEL: nomic-embed-text
    OLLAMA_EMBED_DIMS: "768"
    OLLAMA_EMBED_API_KEY: local
    # Worker concurrency - slow and steady for rate limits
    WORKER_CONCURRENCY: "1"
    # Auto-approve configuration (Phase 1.3 - Autonomous RTL)
    # Set to "true" to enable T0/T1 auto-approval (requires 0.98 confidence)
    AUTO_APPROVE_ALL_TIERS: "true"
    # Tiered confidence thresholds per Appendix A safety guardrails
    AUTO_APPROVE_T0T1_CONFIDENCE: "0.98"
    AUTO_APPROVE_MIN_CONFIDENCE: "0.90"
    # Grace period before auto-approval (hours)
    AUTO_APPROVE_GRACE_HOURS: "1"

x-worker-ocr: &worker-ocr
  image: fiskai-worker-ocr:dev
  restart: unless-stopped
  networks:
    - redis_default
    - coolify
  environment:
    <<: *worker-env

services:
  worker-orchestrator:
    <<: *worker-common
    container_name: fiskai-worker-orchestrator
    command: ["node", "dist/workers/lib/regulatory-truth/workers/orchestrator.worker.js"]

  worker-sentinel:
    <<: *worker-common
    container_name: fiskai-worker-sentinel
    command: ["node", "dist/workers/lib/regulatory-truth/workers/sentinel.worker.js"]

  worker-extractor:
    <<: *worker-common
    container_name: fiskai-worker-extractor
    command: ["node", "dist/workers/lib/regulatory-truth/workers/extractor.worker.js"]

  worker-ocr:
    <<: *worker-ocr
    container_name: fiskai-worker-ocr
    command: ["node", "dist/workers/lib/regulatory-truth/workers/ocr.worker.js"]

  worker-composer:
    <<: *worker-common
    container_name: fiskai-worker-composer
    command: ["node", "dist/workers/lib/regulatory-truth/workers/composer.worker.js"]

  # PHASE-D: Apply worker - handles persistence of composer proposals
  worker-apply:
    <<: *worker-common
    container_name: fiskai-worker-apply
    command: ["node", "dist/workers/lib/regulatory-truth/workers/apply.worker.js"]

  worker-reviewer:
    <<: *worker-common
    container_name: fiskai-worker-reviewer
    command: ["node", "dist/workers/lib/regulatory-truth/workers/reviewer.worker.js"]

  worker-arbiter:
    <<: *worker-common
    container_name: fiskai-worker-arbiter
    command: ["node", "dist/workers/lib/regulatory-truth/workers/arbiter.worker.js"]

  worker-releaser:
    <<: *worker-common
    container_name: fiskai-worker-releaser
    command: ["node", "dist/workers/lib/regulatory-truth/workers/releaser.worker.js"]

  # worker-scheduler: DISABLED - scheduler.worker.js not in build
  # Will run backfill manually via scripts instead

  worker-continuous-drainer:
    <<: *worker-common
    container_name: fiskai-worker-continuous-drainer
    command: ["node", "dist/workers/lib/regulatory-truth/workers/continuous-drainer.worker.js"]

  worker-content-sync:
    <<: *worker-common
    container_name: fiskai-worker-content-sync
    command: ["node", "dist/workers/lib/regulatory-truth/workers/content-sync.worker.js"]

  worker-article:
    <<: *worker-common
    container_name: fiskai-worker-article
    command: ["node", "dist/workers/lib/regulatory-truth/workers/article.worker.js"]

  worker-evidence-embedding:
    <<: *worker-common
    container_name: fiskai-worker-evidence-embedding
    command: ["node", "dist/workers/lib/regulatory-truth/workers/evidence-embedding.worker.js"]

  worker-embedding:
    <<: *worker-common
    container_name: fiskai-worker-embedding
    command: ["node", "dist/workers/lib/regulatory-truth/workers/embedding.worker.js"]

networks:
  redis_default:
    external: true
  coolify:
    external: true
