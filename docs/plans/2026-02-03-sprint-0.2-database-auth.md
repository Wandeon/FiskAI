# Sprint 0.2: Database & Auth Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Connect to PostgreSQL, run migrations, and implement user authentication with NextAuth v5.

**Architecture:** NextAuth v5 with Prisma adapter for session storage. Email/password credentials provider. Protected API routes via tRPC middleware. Database on VPS-01 via Tailscale.

**Tech Stack:** Next.js 16, NextAuth v5, Prisma 7, tRPC 11, PostgreSQL 16, bcrypt, Zod

---

## Prerequisites

- Database running on VPS-01 (100.64.123.81:5434)
- Tailscale connected
- `.env` file with DATABASE_URL

---

## Task 1: Install Dependencies

**Files:**
- Modify: `apps/web/package.json`
- Modify: `packages/db/package.json`

**Step 1: Install auth dependencies in web app**

```bash
cd /home/admin/FiskAI-App
pnpm --filter @fiskai/web add next-auth@beta @auth/prisma-adapter bcryptjs
pnpm --filter @fiskai/web add -D @types/bcryptjs
```

**Step 2: Install dependencies in db package**

```bash
pnpm --filter @fiskai/db add @auth/prisma-adapter
```

**Step 3: Install all workspace dependencies**

```bash
pnpm install
```

**Step 4: Verify installation**

```bash
pnpm ls next-auth --filter @fiskai/web
```
Expected: Shows next-auth@5.x.x

**Step 5: Commit**

```bash
git add -A
git commit -m "chore(deps): add NextAuth v5 and bcrypt dependencies"
```

---

## Task 2: Configure Environment Variables

**Files:**
- Create: `.env` (from .env.example)
- Modify: `apps/web/.env.example`

**Step 1: Create root .env file**

```bash
cp .env.example .env
```

**Step 2: Update .env with actual values**

Edit `/home/admin/FiskAI-App/.env`:
```env
DATABASE_URL="postgresql://fiskai:PASSWORD@100.64.123.81:5434/fiskai_fresh?schema=public"
```

**Step 3: Create web app .env.local**

```bash
cp apps/web/.env.example apps/web/.env.local
```

**Step 4: Update apps/web/.env.local**

```env
DATABASE_URL="postgresql://fiskai:PASSWORD@100.64.123.81:5434/fiskai_fresh?schema=public"
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="generate-32-byte-hex-with-openssl-rand-hex-32"
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_APP_NAME="FiskAI"
```

**Step 5: Generate NEXTAUTH_SECRET**

```bash
openssl rand -hex 32
```

Copy output to NEXTAUTH_SECRET in .env.local

**Step 6: Verify DATABASE_URL connectivity**

```bash
PGPASSWORD=PASSWORD psql -h 100.64.123.81 -p 5434 -U fiskai -d fiskai_fresh -c "SELECT 1"
```
Expected: Returns "1"

**Note:** Do NOT commit .env files - they're in .gitignore

---

## Task 3: Run Prisma Migration

**Files:**
- Creates: `packages/db/prisma/migrations/` (auto-generated)

**Step 1: Generate Prisma client**

```bash
cd /home/admin/FiskAI-App
pnpm db:generate
```
Expected: "Generated Prisma Client"

**Step 2: Create initial migration**

```bash
cd packages/db
DATABASE_URL="postgresql://fiskai:PASSWORD@100.64.123.81:5434/fiskai_fresh?schema=public" npx prisma migrate dev --name init
```
Expected: Migration created and applied

**Step 3: Verify tables created**

```bash
PGPASSWORD=PASSWORD psql -h 100.64.123.81 -p 5434 -U fiskai -d fiskai_fresh -c "\dt"
```
Expected: Shows users, accounts, sessions, companies, invoices, etc.

**Step 4: Commit migration**

```bash
git add packages/db/prisma/migrations
git commit -m "chore(db): add initial migration"
```

---

## Task 4: Create Auth Configuration

**Files:**
- Create: `apps/web/src/lib/auth.ts`
- Create: `apps/web/src/lib/auth.config.ts`

**Step 1: Create auth config file**

Create `apps/web/src/lib/auth.config.ts`:
```typescript
import type { NextAuthConfig } from 'next-auth';
import Credentials from 'next-auth/providers/credentials';
import { z } from 'zod';

const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
});

export const authConfig: NextAuthConfig = {
  pages: {
    signIn: '/login',
    newUser: '/register',
  },
  callbacks: {
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user;
      const isOnDashboard = nextUrl.pathname.startsWith('/dashboard');
      const isOnAuth = nextUrl.pathname.startsWith('/login') ||
                       nextUrl.pathname.startsWith('/register');

      if (isOnDashboard) {
        if (isLoggedIn) return true;
        return false; // Redirect to login
      }

      if (isOnAuth && isLoggedIn) {
        return Response.redirect(new URL('/dashboard', nextUrl));
      }

      return true;
    },
    jwt({ token, user }) {
      if (user) {
        token.id = user.id;
      }
      return token;
    },
    session({ session, token }) {
      if (token && session.user) {
        session.user.id = token.id as string;
      }
      return session;
    },
  },
  providers: [], // Added in auth.ts
};
```

**Step 2: Create main auth file**

Create `apps/web/src/lib/auth.ts`:
```typescript
import NextAuth from 'next-auth';
import Credentials from 'next-auth/providers/credentials';
import { PrismaAdapter } from '@auth/prisma-adapter';
import bcrypt from 'bcryptjs';
import { z } from 'zod';
import { db } from '@fiskai/db';
import { authConfig } from './auth.config';

const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
});

export const { handlers, signIn, signOut, auth } = NextAuth({
  ...authConfig,
  adapter: PrismaAdapter(db),
  session: { strategy: 'jwt' },
  providers: [
    Credentials({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        const parsed = loginSchema.safeParse(credentials);
        if (!parsed.success) return null;

        const { email, password } = parsed.data;

        const user = await db.user.findUnique({
          where: { email },
        });

        if (!user || !user.passwordHash) return null;

        const passwordMatch = await bcrypt.compare(password, user.passwordHash);
        if (!passwordMatch) return null;

        return {
          id: user.id,
          email: user.email,
          name: user.name,
        };
      },
    }),
  ],
});
```

**Step 3: Commit**

```bash
git add apps/web/src/lib/auth.ts apps/web/src/lib/auth.config.ts
git commit -m "feat(auth): add NextAuth v5 configuration with credentials provider"
```

---

## Task 5: Create Auth API Routes

**Files:**
- Create: `apps/web/src/app/api/auth/[...nextauth]/route.ts`

**Step 1: Create NextAuth route handler**

Create `apps/web/src/app/api/auth/[...nextauth]/route.ts`:
```typescript
import { handlers } from '@/lib/auth';

export const { GET, POST } = handlers;
```

**Step 2: Commit**

```bash
git add apps/web/src/app/api/auth
git commit -m "feat(auth): add NextAuth API route handler"
```

---

## Task 6: Create Registration Action

**Files:**
- Create: `apps/web/src/app/(auth)/register/actions.ts`

**Step 1: Create registration server action**

Create `apps/web/src/app/(auth)/register/actions.ts`:
```typescript
'use server';

import { z } from 'zod';
import bcrypt from 'bcryptjs';
import { db } from '@fiskai/db';
import { redirect } from 'next/navigation';

const registerSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters'),
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword'],
});

export type RegisterState = {
  errors?: {
    name?: string[];
    email?: string[];
    password?: string[];
    confirmPassword?: string[];
    _form?: string[];
  };
  success?: boolean;
};

export async function register(
  prevState: RegisterState,
  formData: FormData
): Promise<RegisterState> {
  const rawData = {
    name: formData.get('name'),
    email: formData.get('email'),
    password: formData.get('password'),
    confirmPassword: formData.get('confirmPassword'),
  };

  const parsed = registerSchema.safeParse(rawData);

  if (!parsed.success) {
    return {
      errors: parsed.error.flatten().fieldErrors,
    };
  }

  const { name, email, password } = parsed.data;

  // Check if user exists
  const existingUser = await db.user.findUnique({
    where: { email },
  });

  if (existingUser) {
    return {
      errors: {
        email: ['Email already registered'],
      },
    };
  }

  // Hash password
  const passwordHash = await bcrypt.hash(password, 12);

  // Create user
  await db.user.create({
    data: {
      name,
      email,
      passwordHash,
    },
  });

  redirect('/login?registered=true');
}
```

**Step 2: Commit**

```bash
git add apps/web/src/app/\(auth\)/register/actions.ts
git commit -m "feat(auth): add registration server action"
```

---

## Task 7: Create Login Page

**Files:**
- Create: `apps/web/src/app/(auth)/login/page.tsx`
- Create: `apps/web/src/app/(auth)/layout.tsx`

**Step 1: Create auth layout**

Create `apps/web/src/app/(auth)/layout.tsx`:
```typescript
export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="w-full max-w-md p-8">
        {children}
      </div>
    </div>
  );
}
```

**Step 2: Create login page**

Create `apps/web/src/app/(auth)/login/page.tsx`:
```typescript
import { redirect } from 'next/navigation';
import { auth, signIn } from '@/lib/auth';
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@fiskai/ui';
import Link from 'next/link';

export default async function LoginPage({
  searchParams,
}: {
  searchParams: Promise<{ registered?: string; error?: string }>;
}) {
  const session = await auth();
  if (session) redirect('/dashboard');

  const params = await searchParams;
  const justRegistered = params.registered === 'true';
  const error = params.error;

  async function handleLogin(formData: FormData) {
    'use server';
    await signIn('credentials', {
      email: formData.get('email'),
      password: formData.get('password'),
      redirectTo: '/dashboard',
    });
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Prijava</CardTitle>
        <CardDescription>Prijavite se u FiskAI</CardDescription>
      </CardHeader>
      <CardContent>
        {justRegistered && (
          <div className="mb-4 p-3 bg-green-50 text-green-700 rounded-md text-sm">
            Registracija uspješna! Možete se prijaviti.
          </div>
        )}
        {error && (
          <div className="mb-4 p-3 bg-red-50 text-red-700 rounded-md text-sm">
            Pogrešan email ili lozinka.
          </div>
        )}
        <form action={handleLogin} className="space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium mb-1">
              Email
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              className="w-full px-3 py-2 border rounded-md"
              placeholder="vas@email.hr"
            />
          </div>
          <div>
            <label htmlFor="password" className="block text-sm font-medium mb-1">
              Lozinka
            </label>
            <input
              id="password"
              name="password"
              type="password"
              required
              className="w-full px-3 py-2 border rounded-md"
              placeholder="••••••••"
            />
          </div>
          <button
            type="submit"
            className="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Prijava
          </button>
        </form>
      </CardContent>
      <CardFooter className="justify-center">
        <p className="text-sm text-gray-600">
          Nemate račun?{' '}
          <Link href="/register" className="text-blue-600 hover:underline">
            Registrirajte se
          </Link>
        </p>
      </CardFooter>
    </Card>
  );
}
```

**Step 3: Commit**

```bash
git add apps/web/src/app/\(auth\)
git commit -m "feat(auth): add login page with Croatian UI"
```

---

## Task 8: Create Registration Page

**Files:**
- Create: `apps/web/src/app/(auth)/register/page.tsx`

**Step 1: Create registration page**

Create `apps/web/src/app/(auth)/register/page.tsx`:
```typescript
'use client';

import { useActionState } from 'react';
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@fiskai/ui';
import Link from 'next/link';
import { register, type RegisterState } from './actions';

const initialState: RegisterState = {};

export default function RegisterPage() {
  const [state, formAction, pending] = useActionState(register, initialState);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Registracija</CardTitle>
        <CardDescription>Kreirajte novi FiskAI račun</CardDescription>
      </CardHeader>
      <CardContent>
        <form action={formAction} className="space-y-4">
          <div>
            <label htmlFor="name" className="block text-sm font-medium mb-1">
              Ime
            </label>
            <input
              id="name"
              name="name"
              type="text"
              required
              className="w-full px-3 py-2 border rounded-md"
              placeholder="Vaše ime"
            />
            {state.errors?.name && (
              <p className="text-red-500 text-sm mt-1">{state.errors.name[0]}</p>
            )}
          </div>
          <div>
            <label htmlFor="email" className="block text-sm font-medium mb-1">
              Email
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              className="w-full px-3 py-2 border rounded-md"
              placeholder="vas@email.hr"
            />
            {state.errors?.email && (
              <p className="text-red-500 text-sm mt-1">{state.errors.email[0]}</p>
            )}
          </div>
          <div>
            <label htmlFor="password" className="block text-sm font-medium mb-1">
              Lozinka
            </label>
            <input
              id="password"
              name="password"
              type="password"
              required
              className="w-full px-3 py-2 border rounded-md"
              placeholder="Minimalno 8 znakova"
            />
            {state.errors?.password && (
              <p className="text-red-500 text-sm mt-1">{state.errors.password[0]}</p>
            )}
          </div>
          <div>
            <label htmlFor="confirmPassword" className="block text-sm font-medium mb-1">
              Potvrda lozinke
            </label>
            <input
              id="confirmPassword"
              name="confirmPassword"
              type="password"
              required
              className="w-full px-3 py-2 border rounded-md"
              placeholder="Ponovite lozinku"
            />
            {state.errors?.confirmPassword && (
              <p className="text-red-500 text-sm mt-1">{state.errors.confirmPassword[0]}</p>
            )}
          </div>
          {state.errors?._form && (
            <div className="p-3 bg-red-50 text-red-700 rounded-md text-sm">
              {state.errors._form[0]}
            </div>
          )}
          <button
            type="submit"
            disabled={pending}
            className="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
          >
            {pending ? 'Registracija...' : 'Registrirajte se'}
          </button>
        </form>
      </CardContent>
      <CardFooter className="justify-center">
        <p className="text-sm text-gray-600">
          Već imate račun?{' '}
          <Link href="/login" className="text-blue-600 hover:underline">
            Prijavite se
          </Link>
        </p>
      </CardFooter>
    </Card>
  );
}
```

**Step 2: Commit**

```bash
git add apps/web/src/app/\(auth\)/register/page.tsx
git commit -m "feat(auth): add registration page with form validation"
```

---

## Task 9: Create Dashboard Page (Protected)

**Files:**
- Create: `apps/web/src/app/(app)/dashboard/page.tsx`
- Create: `apps/web/src/app/(app)/layout.tsx`

**Step 1: Create app layout (protected)**

Create `apps/web/src/app/(app)/layout.tsx`:
```typescript
import { redirect } from 'next/navigation';
import { auth, signOut } from '@/lib/auth';

export default async function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();

  if (!session) {
    redirect('/login');
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-xl font-bold">FiskAI</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600">{session.user?.email}</span>
            <form
              action={async () => {
                'use server';
                await signOut({ redirectTo: '/login' });
              }}
            >
              <button
                type="submit"
                className="text-sm text-gray-600 hover:text-gray-900"
              >
                Odjava
              </button>
            </form>
          </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto px-4 py-8">
        {children}
      </main>
    </div>
  );
}
```

**Step 2: Create dashboard page**

Create `apps/web/src/app/(app)/dashboard/page.tsx`:
```typescript
import { auth } from '@/lib/auth';
import { Card, CardHeader, CardTitle, CardContent } from '@fiskai/ui';

export default async function DashboardPage() {
  const session = await auth();

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">Dobrodošli, {session?.user?.name || 'korisniče'}!</h1>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Računi</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">0</p>
            <p className="text-sm text-gray-500">Ukupno izdanih računa</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Ovaj mjesec</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">0,00 €</p>
            <p className="text-sm text-gray-500">Ukupan promet</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Status</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-yellow-600">⚠️ Potrebno postaviti tvrtku</p>
          </CardContent>
        </Card>
      </div>

      <div className="mt-8">
        <Card>
          <CardHeader>
            <CardTitle>Sljedeći koraci</CardTitle>
          </CardHeader>
          <CardContent>
            <ol className="list-decimal list-inside space-y-2 text-sm">
              <li>Postavite podatke o tvrtki (OIB, adresa)</li>
              <li>Definirajte poslovni prostor</li>
              <li>Definirajte naplatni uređaj</li>
              <li>Kreirajte prvi račun</li>
            </ol>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

**Step 3: Commit**

```bash
git add apps/web/src/app/\(app\)
git commit -m "feat(app): add protected dashboard with Croatian UI"
```

---

## Task 10: Update Home Page

**Files:**
- Modify: `apps/web/src/app/page.tsx`

**Step 1: Update home page with links**

Replace `apps/web/src/app/page.tsx`:
```typescript
import Link from 'next/link';
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function HomePage() {
  const session = await auth();

  if (session) {
    redirect('/dashboard');
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-gradient-to-b from-blue-50 to-white">
      <div className="text-center">
        <h1 className="text-5xl font-bold mb-4">FiskAI</h1>
        <p className="text-xl text-gray-600 mb-8">
          Hrvatsko e-fakturiranje, jednostavno.
        </p>
        <div className="flex gap-4 justify-center">
          <Link
            href="/login"
            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            Prijava
          </Link>
          <Link
            href="/register"
            className="px-6 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50"
          >
            Registracija
          </Link>
        </div>
      </div>
    </main>
  );
}
```

**Step 2: Commit**

```bash
git add apps/web/src/app/page.tsx
git commit -m "feat(home): add landing page with auth links"
```

---

## Task 11: Add Middleware for Auth Protection

**Files:**
- Create: `apps/web/src/middleware.ts`

**Step 1: Create middleware**

Create `apps/web/src/middleware.ts`:
```typescript
import { auth } from '@/lib/auth';
import { NextResponse } from 'next/server';

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isOnDashboard = req.nextUrl.pathname.startsWith('/dashboard');
  const isOnApi = req.nextUrl.pathname.startsWith('/api');
  const isOnAuth = req.nextUrl.pathname.startsWith('/login') ||
                   req.nextUrl.pathname.startsWith('/register');

  // Allow API routes
  if (isOnApi) {
    return NextResponse.next();
  }

  // Redirect to login if accessing dashboard without auth
  if (isOnDashboard && !isLoggedIn) {
    return NextResponse.redirect(new URL('/login', req.nextUrl));
  }

  // Redirect to dashboard if accessing auth pages while logged in
  if (isOnAuth && isLoggedIn) {
    return NextResponse.redirect(new URL('/dashboard', req.nextUrl));
  }

  return NextResponse.next();
});

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],
};
```

**Step 2: Commit**

```bash
git add apps/web/src/middleware.ts
git commit -m "feat(auth): add middleware for route protection"
```

---

## Task 12: Integration Test

**Step 1: Start dev server**

```bash
cd /home/admin/FiskAI-App
pnpm dev
```

**Step 2: Test registration flow**

1. Open http://localhost:3000
2. Click "Registracija"
3. Fill form: Name, Email, Password
4. Submit - should redirect to /login with success message

**Step 3: Test login flow**

1. On /login, enter registered credentials
2. Submit - should redirect to /dashboard
3. Should see welcome message and user email in header

**Step 4: Test logout**

1. Click "Odjava" in header
2. Should redirect to /login

**Step 5: Test protection**

1. While logged out, try accessing /dashboard directly
2. Should redirect to /login

**Step 6: Verify in database**

```bash
PGPASSWORD=PASSWORD psql -h 100.64.123.81 -p 5434 -U fiskai -d fiskai_fresh -c "SELECT id, email, name FROM users"
```
Expected: Shows registered user

---

## Task 13: Final Commit & Summary

**Step 1: Run typecheck**

```bash
pnpm typecheck
```
Expected: No errors

**Step 2: Run build**

```bash
pnpm build
```
Expected: Build succeeds

**Step 3: Create summary commit if any files missed**

```bash
git status
# If any uncommitted files:
git add -A
git commit -m "chore: sprint 0.2 cleanup"
```

**Step 4: Update ROADMAP.md**

Mark Sprint 0.2 tasks as complete in docs/ROADMAP.md

---

## Sprint 0.2 Gate Checklist

- [ ] User can register with email/password
- [ ] User can login with credentials
- [ ] User can logout
- [ ] Dashboard is protected (redirects to login)
- [ ] Auth pages redirect to dashboard when logged in
- [ ] Database has user records
- [ ] `pnpm build` passes
- [ ] `pnpm typecheck` passes

---

## Files Created/Modified Summary

**Created:**
- `apps/web/src/lib/auth.ts`
- `apps/web/src/lib/auth.config.ts`
- `apps/web/src/app/api/auth/[...nextauth]/route.ts`
- `apps/web/src/app/(auth)/layout.tsx`
- `apps/web/src/app/(auth)/login/page.tsx`
- `apps/web/src/app/(auth)/register/page.tsx`
- `apps/web/src/app/(auth)/register/actions.ts`
- `apps/web/src/app/(app)/layout.tsx`
- `apps/web/src/app/(app)/dashboard/page.tsx`
- `apps/web/src/middleware.ts`
- `packages/db/prisma/migrations/` (auto-generated)

**Modified:**
- `apps/web/src/app/page.tsx`
- `apps/web/package.json`
- `packages/db/package.json`
