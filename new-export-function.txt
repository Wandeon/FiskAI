/**
 * Export tenant data as JSON
 *
 * Security improvements:
 * - Rate limiting (max 10 exports/hour per admin)
 * - Audit logging of all exports
 * - Redacted sensitive fields (bank balances, yearly revenue)
 * - Records who exported the data
 * - Notifications to tenant admins
 */
export async function exportTenantData(
  companyId: string
): Promise<{ success: boolean; data?: any; error?: string }> {
  try {
    // Require ADMIN role
    const admin = await requireAdmin()

    // Rate limiting: Max 10 exports per hour per admin
    const rateLimitCheck = await checkRateLimit(admin.id, "ADMIN_EXPORT")
    if (!rateLimitCheck.allowed) {
      const resetMinutes = rateLimitCheck.resetAt
        ? Math.ceil((rateLimitCheck.resetAt - Date.now()) / 60000)
        : 60
      return {
        success: false,
        error: `Ograničenje stope: Maksimalno 10 izvoza po satu. Pokušajte ponovno za ${resetMinutes} min.`,
      }
    }

    // Fetch comprehensive tenant data
    const company = await db.company.findUnique({
      where: { id: companyId },
      include: {
        users: {
          include: { user: true },
        },
        eInvoices: {
          select: {
            id: true,
            direction: true,
            invoiceNumber: true,
            issueDate: true,
            totalAmount: true,
            status: true,
            createdAt: true,
          },
          orderBy: { createdAt: "desc" },
          take: 100, // Limit to recent invoices
        },
        expenses: {
          select: {
            id: true,
            description: true,
            date: true,
            totalAmount: true,
            status: true,
            createdAt: true,
          },
          orderBy: { createdAt: "desc" },
          take: 100,
        },
        contacts: {
          select: {
            id: true,
            type: true,
            name: true,
            email: true,
            createdAt: true,
          },
        },
        bankAccounts: {
          select: {
            id: true,
            name: true,
            iban: true,
            currency: true,
            // currentBalance: REDACTED for security
          },
        },
      },
    })

    if (!company) {
      return { success: false, error: "Tvrtka nije pronađena" }
    }

    // Calculate statistics (excluding sensitive business metrics)
    const totalInvoices = company.eInvoices.length
    const totalExpenses = company.expenses.length
    const totalContacts = company.contacts.length

    const exportData = {
      exportedAt: new Date().toISOString(),
      exportedBy: {
        id: admin.id,
        email: admin.email,
        name: admin.name,
      },
      company: {
        id: company.id,
        name: company.name,
        oib: company.oib,
        legalForm: company.legalForm,
        isVatPayer: company.isVatPayer,
        fiscalEnabled: company.fiscalEnabled,
        createdAt: company.createdAt,
        subscriptionPlan: company.subscriptionPlan,
        subscriptionStatus: company.subscriptionStatus,
        entitlements: company.entitlements,
        featureFlags: company.featureFlags,
      },
      users: company.users.map((cu) => ({
        email: cu.user.email,
        name: cu.user.name,
        role: cu.role,
        createdAt: cu.user.createdAt,
        lastLogin: cu.user.updatedAt,
      })),
      statistics: {
        totalInvoices,
        totalExpenses,
        totalContacts,
        totalBankAccounts: company.bankAccounts.length,
        // yearlyRevenue: REDACTED - sensitive business metric
      },
      invoices: company.eInvoices,
      expenses: company.expenses,
      contacts: company.contacts,
      bankAccounts: company.bankAccounts.map((account) => ({
        id: account.id,
        name: account.name,
        iban: account.iban,
        currency: account.currency,
        // currentBalance: REDACTED for security
      })),
    }

    // Audit logging: Record who exported what data
    await logAudit({
      companyId,
      userId: admin.id,
      action: "EXPORT",
      entity: "Company",
      entityId: companyId,
      changes: {
        after: {
          exportType: "full_tenant_data",
          recordCounts: {
            users: company.users.length,
            invoices: totalInvoices,
            expenses: totalExpenses,
            contacts: totalContacts,
            bankAccounts: company.bankAccounts.length,
          },
        },
      },
    })

    // Send notification to tenant's primary admin
    try {
      const primaryAdminUser = company.users.find((cu) => cu.role === "ADMIN")
      if (primaryAdminUser?.user.email) {
        // Note: Email notification would be sent here in production
        // For now, we just log it
        console.log(
          `[SECURITY] Tenant data exported for company ${company.name} (${companyId}) by admin ${admin.email}`
        )
        console.log(`[SECURITY] Notification should be sent to: ${primaryAdminUser.user.email}`)
      }
    } catch (notificationError) {
      // Don't fail the export if notification fails
      console.error("Failed to send export notification:", notificationError)
    }

    return { success: true, data: exportData }
  } catch (error) {
    console.error("Error exporting tenant data:", error)
    return {
      success: false,
      error: error instanceof Error ? error.message : "Nepoznata greška",
    }
  }
}
