// =============================================================================
// FiskAI - Database Schema
// =============================================================================
// Croatian e-invoicing application database schema.
// Keep this file under 500 lines. Split into multiple files if needed.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CORE MODELS - User & Company
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  systemRole    SystemRole @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  memberships   CompanyMember[]
  sessions      Session[]
  accounts      Account[]

  @@map("users")
}

enum SystemRole {
  USER
  STAFF
  ADMIN
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Company {
  id        String   @id @default(cuid())
  name      String
  oib       String   @unique // Croatian tax number
  address   String?
  city      String?
  zipCode   String?
  country   String   @default("HR")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members          CompanyMember[]
  businessPremises BusinessPremises[]
  invoices         Invoice[]
  contacts         Contact[]

  @@map("companies")
}

model CompanyMember {
  id        String      @id @default(cuid())
  userId    String
  companyId String
  role      CompanyRole @default(MEMBER)
  createdAt DateTime    @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

enum CompanyRole {
  OWNER
  ADMIN
  MEMBER
}

// =============================================================================
// BUSINESS SETUP - Croatian fiscalization requirements
// =============================================================================

model BusinessPremises {
  id           String   @id @default(cuid())
  companyId    String
  code         String   // Oznaka poslovnog prostora (e.g., "1", "PRODAVAONICA")
  name         String
  address      String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  paymentDevices PaymentDevice[]
  invoices       Invoice[]

  @@unique([companyId, code])
  @@map("business_premises")
}

model PaymentDevice {
  id                 String   @id @default(cuid())
  businessPremisesId String
  code               String   // Oznaka naplatnog ureÄ‘aja (e.g., "1", "2")
  name               String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())

  businessPremises BusinessPremises @relation(fields: [businessPremisesId], references: [id], onDelete: Cascade)
  invoices         Invoice[]

  @@unique([businessPremisesId, code])
  @@map("payment_devices")
}

model InvoiceSequence {
  id                 String   @id @default(cuid())
  companyId          String
  businessPremisesId String
  paymentDeviceId    String
  year               Int
  lastNumber         Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([companyId, businessPremisesId, paymentDeviceId, year])
  @@map("invoice_sequences")
}

// =============================================================================
// INVOICING
// =============================================================================

model Contact {
  id        String      @id @default(cuid())
  companyId String
  type      ContactType
  name      String
  oib       String?
  email     String?
  phone     String?
  address   String?
  city      String?
  zipCode   String?
  country   String      @default("HR")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@map("contacts")
}

enum ContactType {
  CUSTOMER
  SUPPLIER
  BOTH
}

model Invoice {
  id                   String        @id @default(cuid())
  companyId            String
  businessPremisesId   String
  paymentDeviceId      String
  contactId            String?

  // Croatian invoice number format: broj-oznaka_prostora-oznaka_uredaja
  invoiceNumber        Int           // Sequential number within year
  invoiceNumberFull    String        @unique // e.g., "1-1-1" (broj-prostor-uredaj)
  year                 Int

  status               InvoiceStatus @default(DRAFT)
  issueDate            DateTime
  dueDate              DateTime?
  deliveryDate         DateTime?

  // Amounts (stored in cents/lipe)
  subtotalCents        Int           @default(0)
  vatAmountCents       Int           @default(0)
  totalCents           Int           @default(0)
  currency             String        @default("EUR")

  // E-invoice fields (Phase 2)
  eInvoiceId           String?       // External ID from e-poslovanje
  eInvoiceSentAt       DateTime?
  eInvoiceStatus       String?       // SENT, DELIVERED, ACCEPTED, REJECTED

  notes                String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  businessPremises BusinessPremises @relation(fields: [businessPremisesId], references: [id])
  paymentDevice    PaymentDevice    @relation(fields: [paymentDeviceId], references: [id])
  contact          Contact?         @relation(fields: [contactId], references: [id])
  lines            InvoiceLine[]

  @@index([companyId, year])
  @@index([status])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  DELIVERED
  ACCEPTED
  REJECTED
  CANCELLED
}

model InvoiceLine {
  id          String @id @default(cuid())
  invoiceId   String
  sortOrder   Int    @default(0)

  description String
  quantity    Int    @default(100) // Stored as quantity * 100 for precision
  unitPrice   Int    // Price in cents/lipe
  vatRate     Int    @default(25) // VAT percentage (25, 13, 5, 0)

  // Calculated totals (in cents)
  lineTotalCents Int @default(0)
  vatAmountCents Int @default(0)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_lines")
}
